<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Text Editor</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #121212;
        color: #ffffff;
        transition: background-color 0.3s, color 0.3s;
    }

    h1 { text-align: center; margin-bottom: 10px; }

    #backButton {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #1a73e8;
        color: #fff;
        transition: background-color 0.3s;
        z-index: 1000;
    }

    #backButton:hover { background-color: #155ab6; }

    #editor {
        display: block;
        width: 90%;
        max-width: 800px;
        height: 400px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #555;
        border-radius: 5px;
        resize: vertical;
        background-color: #1e1e1e;
        color: #ffffff;
        margin: 0 auto;
        transition: background-color 0.3s, color 0.3s;
    }

    .buttons, .settings {
        margin: 10px auto;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        width: 90%;
        max-width: 800px;
    }

    button {
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #1a73e8;
        color: #fff;
        transition: background-color 0.3s;
    }

    button:hover { background-color: #155ab6; }

    label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
    }

    select, input[type="color"], input[type="number"] { padding: 3px; }

    .settings-panel {
        border: 1px solid #555;
        padding: 10px;
        border-radius: 5px;
        background-color: #1e1e1e;
        width: 90%;
        max-width: 800px;
        margin: 10px auto;
        transition: background-color 0.3s, color 0.3s;
    }

    .counts {
        margin: 10px auto;
        font-size: 14px;
        width: 90%;
        max-width: 800px;
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
    }
</style>
</head>
<body>
<button id="backButton">Back</button>
<h1>Advanced Text Editor</h1>

<textarea id="editor" placeholder="Start typing..." spellcheck="true"></textarea>

<div class="buttons">
    <button onclick="saveText()">Save</button>
    <button onclick="clearText()">Clear</button>
    <button onclick="exportHistory()">Export Version History</button>
    <button onclick="importText()">Import</button>
    <input type="file" id="fileInput" accept=".txt" style="display:none">
</div>

<div class="counts" id="counts">
    Words: 0 | Letters: 0 | Spaces: 0 | Sentences: 0
</div>

<div class="settings-panel">
    <h3>Settings</h3>
    <div class="settings">
        <label>Font Size:
            <input type="number" id="fontSize" value="16" min="8" max="48"> px
        </label>
        <label>Font Family:
            <select id="fontFamily">
                <option value="Arial, sans-serif">Arial</option>
                <option value="Courier New, monospace">Courier New</option>
                <option value="Times New Roman, serif">Times New Roman</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Trebuchet MS, sans-serif">Trebuchet MS</option>
                <option value="Comic Sans MS, cursive, sans-serif">Comic Sans MS</option>
                <option value="Impact, sans-serif">Impact</option>
            </select>
        </label>
        <label>Background:
            <input type="color" id="bgColor" value="#1e1e1e">
        </label>
        <label>Spell Check:
            <input type="checkbox" id="spellCheck" checked>
        </label>
    </div>
</div>

<script>
const editor = document.getElementById('editor');
const countsDisplay = document.getElementById('counts');
const fileInput = document.getElementById('fileInput');
const backButton = document.getElementById('backButton');
let versionHistory = [];

// Color inversion
function getBrightness(hex) {
    const r = parseInt(hex.substring(1,3),16);
    const g = parseInt(hex.substring(3,5),16);
    const b = parseInt(hex.substring(5,7),16);
    return (r*299 + g*587 + b*114)/1000;
}
function updateTextColor(bgColor) {
    const brightness = getBrightness(bgColor);
    editor.style.color = (brightness < 128) ? '#ffffff' : '#000000';
}

// Save
function saveText() {
    const text = editor.value;
    const blob = new Blob([text], { type: 'text/plain' });
    const link = document.createElement('a');
    link.download = 'text.txt';
    link.href = URL.createObjectURL(blob);
    link.click();
}

// Clear
function clearText() {
    if(confirm("Are you sure you want to clear the text?")) {
        editor.value = '';
        updateCounts();
        addVersion('Clear');
    }
}

// Back button with confirmation
backButton.addEventListener('click', () => {
    if(editor.value.trim().length > 0) {
        if(!confirm("You have text in the editor. Are you sure you want to go back? Unsaved changes will be lost.")) return;
    }
    window.location.href = '../content/pages/section2.html';
});

// Counts
function updateCounts() {
    const text = editor.value;
    const words = text.trim().length ? text.trim().split(/\s+/).length : 0;
    const letters = text.replace(/\s/g,'').length;
    const spaces = (text.match(/\s/g) || []).length;
    const sentences = (text.match(/[.!?]+/g) || []).length;
    countsDisplay.textContent = `Words: ${words} | Letters: ${letters} | Spaces: ${spaces} | Sentences: ${sentences}`;
}

// Version history
function addVersion(eventInfo='') {
    const now = new Date().toISOString();
    versionHistory.push({timestamp: now, text: editor.value, event: eventInfo});
}

function exportHistory() {
    if(versionHistory.length === 0){ alert('No versions recorded.'); return; }
    let csv = 'Timestamp,Event,Text\n';
    versionHistory.forEach(v=>{
        const safeText = v.text.replace(/"/g,'""');
        const safeEvent = v.event.replace(/"/g,'""');
        csv += `"${v.timestamp}","${safeEvent}","${safeText}"\n`;
    });
    const blob = new Blob([csv],{type:'text/csv'});
    const link = document.createElement('a');
    link.download = 'version_history.csv';
    link.href = URL.createObjectURL(blob);
    link.click();
}

// Import
function importText() { fileInput.click(); }
fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(file && file.type === "text/plain"){
        const reader = new FileReader();
        reader.onload = () => {
            editor.value = reader.result;
            updateCounts();
            addVersion('Imported File');
        };
        reader.readAsText(file);
    }
});
// Drag & drop
editor.addEventListener('dragover', e => e.preventDefault());
editor.addEventListener('drop', e => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if(file && file.type === "text/plain"){
        const reader = new FileReader();
        reader.onload = () => {
            editor.value = reader.result;
            updateCounts();
            addVersion('Dropped File');
        };
        reader.readAsText(file);
    }
});

// Settings
const fontSizeInput = document.getElementById('fontSize');
const fontFamilySelect = document.getElementById('fontFamily');
const bgColorInput = document.getElementById('bgColor');
const spellCheckInput = document.getElementById('spellCheck');

fontSizeInput.addEventListener('input', () => editor.style.fontSize = fontSizeInput.value+'px');
fontFamilySelect.addEventListener('change', () => editor.style.fontFamily = fontFamilySelect.value);
bgColorInput.addEventListener('input', () => { editor.style.backgroundColor = bgColorInput.value; updateTextColor(bgColorInput.value); });
spellCheckInput.addEventListener('change', () => editor.spellcheck = spellCheckInput.checked);

// Ctrl+S
document.addEventListener('keydown', e => {
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveText(); addVersion('Ctrl+S Save'); }
});

// Version updates for space, enter, or key combos
editor.addEventListener('keydown', e => {
    const isCombo = e.ctrlKey || e.metaKey;
    if(e.key === ' ' || e.key === 'Enter') addVersion(`Key: ${e.key}`);
    else if(isCombo && ['c','v','x','z','a'].includes(e.key.toLowerCase())){
        addVersion(`Key Combo: ${e.ctrlKey ? 'Ctrl+' : ''}${e.metaKey ? 'Cmd+' : ''}${e.key.toUpperCase()}`);
    }
    setTimeout(updateCounts,0);
});

// Initialize
editor.style.backgroundColor = bgColorInput.value;
updateTextColor(bgColorInput.value);
editor.spellcheck = spellCheckInput.checked;
darkModeInput.checked = true;
document.body.classList.add('dark-mode');
updateCounts();
addVersion('Initial Version');
</script>
</body>
</html>
